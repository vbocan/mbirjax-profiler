# MBIRJAX Profiler for FPGA Optimization Analysis
# XLA-level profiling with jax.profiler.trace + TensorBoard/XProf
#
# Services:
#   profiler-gpu  — Full GPU profiling with CUDA/CUPTI (requires NVIDIA GPU)
#   profiler-cpu  — CPU-only profiling (works on any machine)

x-common: &common
  stdin_open: true
  tty: true
  working_dir: /output
  volumes:
    - ./output:/output
    - ./scripts:/scripts

services:
  profiler-gpu:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: nvidia/cuda:12.8.0-devel-ubuntu22.04
        JAX_PACKAGE: "jax[cuda12]"
    image: mbirjax-profiler:gpu
    container_name: mbirjax-profiler-gpu

    shm_size: '16gb'

    environment:
      # JAX XLA configuration
      - JAX_PLATFORMS=cuda,cpu
      - XLA_PYTHON_CLIENT_PREALLOCATE=true
      - XLA_PYTHON_CLIENT_MEM_FRACTION=0.8
      - TF_CPP_MIN_LOG_LEVEL=2
      - OUTPUT_DIR=/output
      # Expose all NVIDIA driver capabilities (compute, utility, AND profiling/CUPTI)
      - NVIDIA_DRIVER_CAPABILITIES=all
      # XLA HLO graph dumps (text + interactive HTML graphs)
      - XLA_FLAGS=--xla_dump_to=/output/hlo_dumps_xla --xla_dump_hlo_as_text --xla_dump_hlo_as_html=true --xla_gpu_enable_command_buffer=

    # Required for CUPTI GPU profiling access inside the container
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp:unconfined

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ulimits:
      memlock:
        soft: -1
        hard: -1

    ports:
      - "6006:6006"  # TensorBoard

  profiler-cpu:
    <<: *common
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: ubuntu:22.04
        JAX_PACKAGE: jax
    image: mbirjax-profiler:cpu
    container_name: mbirjax-profiler-cpu

    environment:
      - JAX_PLATFORMS=cpu
      - TF_CPP_MIN_LOG_LEVEL=2
      - OUTPUT_DIR=/output
      # XLA HLO graph dumps (text + interactive HTML graphs)
      - XLA_FLAGS=--xla_dump_to=/output/hlo_dumps_xla --xla_dump_hlo_as_text --xla_dump_hlo_as_html=true

    ports:
      - "6006:6006"  # TensorBoard
