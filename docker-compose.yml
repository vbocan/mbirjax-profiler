# MBIRJAX Profiler for FPGA Optimization Analysis
# GPU profiling with Scalene â€” requires Docker Compose V2

services:
  mbirjax-profiler:
    build:
      context: .
      dockerfile: Dockerfile
    image: mbirjax-profiler:latest
    container_name: mbirjax-profiler

    shm_size: '16gb'

    environment:
      # JAX XLA configuration for GPU profiling
      - JAX_PLATFORMS=cuda,cpu
      - XLA_PYTHON_CLIENT_PREALLOCATE=true
      - XLA_PYTHON_CLIENT_MEM_FRACTION=0.8
      - TF_CPP_MIN_LOG_LEVEL=2
      # Output directory for profiling results
      - OUTPUT_DIR=/output

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ulimits:
      memlock:
        soft: -1
        hard: -1

    volumes:
      - ./output:/output
      - ./scripts:/scripts

    stdin_open: true
    tty: true
    working_dir: /output
